# ğŸ¯ BGE-M3 Danbooruè®­ç»ƒé…ç½®æ–‡ä»¶
# ================================

# æ¨¡å‹é…ç½®
model:
  name: "BAAI/bge-m3"
  device: "cuda"  # cuda/cpu/auto
  use_fp16: true
  normalize_embeddings: true
  max_length: 512
  
  # BGE-M3ç‰¹æœ‰é…ç½®
  return_dense: true      # Denseå‘é‡ï¼ˆä¼ ç»Ÿembeddingï¼‰
  return_sparse: true     # Sparseå‘é‡ï¼ˆå…³é”®è¯åŒ¹é…ï¼‰
  return_colbert_vecs: true  # ColBERTå‘é‡ï¼ˆç»†ç²’åº¦äº¤äº’ï¼‰

# æ•°æ®é…ç½®
data:
  # è¾“å…¥æ•°æ®è·¯å¾„
  input_file: "danbooru_tags.jsonl"
  
  # æ•°æ®æºç±»å‹
  source_type: "local"  # local/api/tags
  source_path: "danbooru2024_complete.parquet"
  data_format: "parquet"  # parquet/csv/json/txt
  
  # æ•°æ®å¤„ç†
  max_items: null  # nullè¡¨ç¤ºå¤„ç†æ‰€æœ‰æ•°æ®
  shuffle: true
  test_split: 0.1
  
  # æ–‡æœ¬é¢„å¤„ç†
  max_text_length: 512
  min_text_length: 5
  remove_duplicates: true

# è®­ç»ƒé…ç½®
training:
  # æ‰¹å¤„ç†è®¾ç½®
  batch_size: 32
  eval_batch_size: 64
  gradient_accumulation_steps: 1
  
  # ä¼˜åŒ–å™¨è®¾ç½®
  learning_rate: 2e-5
  weight_decay: 0.01
  warmup_ratio: 0.1
  max_grad_norm: 1.0
  
  # è®­ç»ƒè¿‡ç¨‹
  num_epochs: 3
  save_steps: 500
  eval_steps: 500
  logging_steps: 100
  
  # æ—©åœ
  early_stopping_patience: 3
  metric_for_best_model: "eval_loss"
  
  # è¾“å‡ºç›®å½•
  output_dir: "artifacts/training/bge_m3_danbooru"
  save_total_limit: 3

# ChromaDBå‘é‡å­˜å‚¨é…ç½®
vector_store:
  db_directory: "artifacts/vector_stores/chroma_db"
  collection_name_prefix: "danbooru_bge_m3"
  embedding_function: "custom_bge_m3"
  
  # ChromaDBè®¾ç½®
  distance_metric: "cosine"  # cosine/l2/ip
  hnsw_space: "cosine"
  
  # ç´¢å¼•é…ç½®
  ef_construction: 200
  ef_search: 100
  max_connections: 16

# ç¡¬ä»¶é…ç½®
hardware:
  # GPUè®¾ç½®
  gpu_memory_threshold: 8e9  # 8GB
  use_mixed_precision: true
  dataloader_num_workers: 4
  
  # å†…å­˜ç®¡ç†
  max_memory_usage: 0.8  # 80%æœ€å¤§å†…å­˜ä½¿ç”¨
  garbage_collect_frequency: 100  # æ¯100æ­¥æ‰§è¡Œä¸€æ¬¡åƒåœ¾å›æ”¶
  
  # CUDAè®¾ç½®
  cuda_launch_blocking: false
  allow_tf32: true

# æ—¥å¿—å’Œç›‘æ§
logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  file: "artifacts/logs/training.log"
  
  # ç›‘æ§é…ç½®
  enable_tensorboard: true
  tensorboard_dir: "artifacts/logs/tensorboard"
  
  # æ€§èƒ½ç›‘æ§
  monitor_gpu_memory: true
  monitor_training_time: true
  log_model_parameters: true

# éªŒè¯å’Œæµ‹è¯•
evaluation:
  # è¯„ä¼°æ•°æ®é›†
  eval_dataset_size: 1000
  test_queries: [
    "1girl, anime style",
    "landscape, detailed background", 
    "portrait, high quality",
    "school uniform, character design",
    "fantasy art, digital painting"
  ]
  
  # è¯„ä¼°æŒ‡æ ‡
  metrics: ["loss", "accuracy", "recall@k"]
  recall_k_values: [1, 5, 10, 20]
  
  # è¯„ä¼°è®¾ç½®
  eval_batch_size: 64
  eval_accumulation_steps: 1

# éƒ¨ç½²é…ç½®
deployment:
  # æ¨¡å‹å¯¼å‡º
  export_format: "safetensors"
  export_path: "artifacts/models/final_model"
  
  # æœåŠ¡é…ç½®
  server_port: 8000
  server_host: "0.0.0.0"
  max_concurrent_requests: 10
  
  # ç¼“å­˜è®¾ç½®
  enable_cache: true
  cache_size: 1000
  cache_ttl: 3600  # 1å°æ—¶

# å®éªŒé…ç½®
experiment:
  # å®éªŒåç§°å’Œç‰ˆæœ¬
  name: "danbooru_bge_m3_v1"
  version: "1.0.0"
  description: "BGE-M3æ¨¡å‹åœ¨Danbooruæ•°æ®é›†ä¸Šçš„å¾®è°ƒå®éªŒ"
  
  # éšæœºç§å­
  seed: 42
  
  # è¶…å‚æ•°æœç´¢
  hyperparameter_search: false
  search_space:
    learning_rate: [1e-5, 2e-5, 5e-5]
    batch_size: [16, 32, 64]
    num_epochs: [2, 3, 5]

# å®‰å…¨å’Œåˆè§„
security:
  # å†…å®¹è¿‡æ»¤
  enable_content_filter: true
  nsfw_threshold: 0.8
  
  # æ•°æ®éšç§
  anonymize_logs: true
  data_retention_days: 30
  
  # è®¿é—®æ§åˆ¶
  require_api_key: false
  rate_limit: 100  # æ¯åˆ†é’Ÿè¯·æ±‚æ•°

# é«˜çº§åŠŸèƒ½
advanced:
  # ä¸‰é‡å‘é‡åŠŸèƒ½
  use_triple_vectors: true
  dense_weight: 0.4
  sparse_weight: 0.3
  colbert_weight: 0.3
  
  # æ™ºèƒ½æ¨è
  enable_smart_recommendations: true
  recommendation_cache_size: 5000
  
  # å¤šè¯­è¨€æ”¯æŒ
  multilingual: true
  supported_languages: ["zh", "en", "ja"]
  
  # å®éªŒæ€§åŠŸèƒ½
  experimental_features:
    dynamic_batching: false
    adaptive_learning_rate: false
    knowledge_distillation: false

# æ•…éšœæ’é™¤
troubleshooting:
  # å¸¸è§é—®é¢˜è§£å†³
  auto_fix_memory_issues: true
  auto_reduce_batch_size: true
  fallback_to_cpu: true
  
  # è°ƒè¯•æ¨¡å¼
  debug_mode: false
  verbose_logging: false
  save_intermediate_results: false